<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de QI - Descubra Seu QI Real</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4C4BC7',
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
        
        .gradient-text {
            background: linear-gradient(45deg, #60a5fa, #34d399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .glow-animation {
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { filter: drop-shadow(0 0 10px rgba(96, 165, 250, 0.5)); }
            to { filter: drop-shadow(0 0 20px rgba(52, 211, 153, 0.5)); }
        }
        
        .shimmer {
            position: relative;
            overflow: hidden;
        }
        
        .shimmer::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .score-circle {
            background: conic-gradient(from 0deg, var(--primary-color) 0%, #06b6d4 var(--percentage), transparent var(--percentage));
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #5D5CDE;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="gradient-bg text-white min-h-screen">
    <!-- Dark mode detection -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <div class="container mx-auto px-4 py-8 max-w-4xl min-h-screen flex flex-col justify-center">
        <!-- Tela Inicial -->
        <div id="home-screen" class="text-center">
            <div class="mb-12">
                <h1 class="text-4xl md:text-6xl font-bold gradient-text glow-animation mb-6">
                    Descubra Seu QI Real
                </h1>
                <p class="text-xl text-gray-300 mb-8 max-w-2xl mx-auto">
                    Teste cient√≠fico com 30 perguntas cuidadosamente elaboradas para avaliar sua intelig√™ncia
                </p>
                <button 
                    onclick="startQuiz()" 
                    class="bg-primary hover:bg-primary-dark text-white font-semibold py-4 px-8 rounded-full text-lg transition-all duration-300 transform hover:scale-105 hover:shadow-xl"
                >
                    Iniciar Teste
                </button>
            </div>
            
            <div class="grid md:grid-cols-3 gap-6 mt-12 text-center">
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                    <div class="w-12 h-12 mx-auto mb-3 bg-primary/20 rounded-xl flex items-center justify-center">
                        <div class="text-primary font-bold text-xl">10'</div>
                    </div>
                    <h3 class="font-semibold mb-2">R√°pido</h3>
                    <p class="text-sm text-gray-300">Apenas 10-15 minutos</p>
                </div>
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                    <div class="w-12 h-12 mx-auto mb-3 bg-primary/20 rounded-xl flex items-center justify-center">
                        <div class="text-primary font-bold text-xl">‚òÖ</div>
                    </div>
                    <h3 class="font-semibold mb-2">Preciso</h3>
                    <p class="text-sm text-gray-300">Baseado em m√©todos cient√≠ficos</p>
                </div>
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                    <div class="w-12 h-12 mx-auto mb-3 bg-primary/20 rounded-xl flex items-center justify-center">
                        <div class="text-primary font-bold text-xl">‚àû</div>
                    </div>
                    <h3 class="font-semibold mb-2">Detalhado</h3>
                    <p class="text-sm text-gray-300">An√°lise completa de suas habilidades</p>
                </div>
            </div>
        </div>

        <!-- Quiz -->
        <div id="quiz-screen" class="hidden">
            <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 md:p-8 border border-white/20">
                <!-- Barra de Progresso -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span id="question-counter" class="text-sm text-gray-300">Pergunta 1 de 30</span>
                        <span id="progress-text" class="text-sm text-gray-300">0%</span>
                    </div>
                    <div class="w-full bg-white/20 rounded-full h-2 shimmer">
                        <div id="progress-fill" class="bg-gradient-to-r from-primary to-cyan-400 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Pergunta -->
                <div class="mb-8">
                    <h2 id="question-text" class="text-xl md:text-2xl font-semibold leading-relaxed"></h2>
                </div>

                <!-- Op√ß√µes -->
                <div id="options-container" class="space-y-3 mb-8"></div>

                <!-- Bot√µes -->
                <div class="flex gap-4">
                    <button 
                        id="next-btn" 
                        onclick="nextQuestion()" 
                        disabled
                        class="flex-1 bg-primary hover:bg-primary-dark disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 text-base"
                    >
                        Pr√≥xima
                    </button>
                    <button 
                        id="finish-btn" 
                        onclick="finishQuizWithValidation()" 
                        class="hidden flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 text-base"
                    >
                        Ver Meu Resultado
                    </button>
                </div>
            </div>
        </div>

        <!-- Resultado -->
        <div id="result-screen" class="hidden">
            <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 border border-white/20">
                <h2 class="text-3xl font-bold mb-8 text-center">Seu Resultado Completo</h2>
                
                <!-- Score Principal -->
                <div class="text-center mb-12">
                    <div id="score-circle" class="score-circle w-48 h-48 rounded-full mx-auto flex items-center justify-center relative mb-6" style="--primary-color: #5D5CDE; --percentage: 0deg;">
                        <div class="absolute inset-3 bg-slate-800 rounded-full flex items-center justify-center">
                            <div class="text-center">
                                <div id="score-text" class="text-4xl font-bold">--</div>
                                <div class="text-sm text-gray-300">QI</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="level-text" class="text-2xl font-semibold mb-4"></div>
                    <div id="level-description" class="text-gray-300 mb-6 max-w-2xl mx-auto"></div>
                </div>

                <!-- Estat√≠sticas Detalhadas -->
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white/5 rounded-xl p-6 border border-white/10">
                        <h3 class="text-lg font-semibold mb-4 text-center">An√°lise de Desempenho</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-300">Acertos:</span>
                                <span id="correct-answers" class="font-semibold">--/30</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">Percentual:</span>
                                <span id="percentage-score" class="font-semibold">--%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">Tempo m√©dio por quest√£o:</span>
                                <span id="avg-time" class="font-semibold">--s</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">N√≠vel de dificuldade:</span>
                                <span id="difficulty-level" class="font-semibold">Avan√ßado</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white/5 rounded-xl p-6 border border-white/10">
                        <h3 class="text-lg font-semibold mb-4 text-center">Comparativo Populacional</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-300">Posi√ß√£o no ranking:</span>
                                <span id="population-rank" class="font-semibold">Top --%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">Pessoas com QI menor:</span>
                                <span id="lower-qi" class="font-semibold">--% da popula√ß√£o</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">Faixa et√°ria equivalente:</span>
                                <span id="age-equivalent" class="font-semibold">-- anos</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">Classifica√ß√£o cient√≠fica:</span>
                                <span id="scientific-classification" class="font-semibold">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Habilidades por Categoria -->
                <div class="bg-white/5 rounded-xl p-6 border border-white/10 mb-8">
                    <h3 class="text-lg font-semibold mb-6 text-center">An√°lise por Habilidades</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <div class="mb-4">
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-300">Racioc√≠nio L√≥gico</span>
                                    <span id="logic-score" class="font-semibold">--%</span>
                                </div>
                                <div class="w-full bg-white/20 rounded-full h-2">
                                    <div id="logic-bar" class="bg-primary h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-300">Matem√°tica</span>
                                    <span id="math-score" class="font-semibold">--%</span>
                                </div>
                                <div class="w-full bg-white/20 rounded-full h-2">
                                    <div id="math-bar" class="bg-cyan-400 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-300">Vocabul√°rio</span>
                                    <span id="vocabulary-score" class="font-semibold">--%</span>
                                </div>
                                <div class="w-full bg-white/20 rounded-full h-2">
                                    <div id="vocabulary-bar" class="bg-green-400 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="mb-4">
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-300">Sequ√™ncias</span>
                                    <span id="sequences-score" class="font-semibold">--%</span>
                                </div>
                                <div class="w-full bg-white/20 rounded-full h-2">
                                    <div id="sequences-bar" class="bg-yellow-400 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-300">Resolu√ß√£o de Problemas</span>
                                    <span id="problems-score" class="font-semibold">--%</span>
                                </div>
                                <div class="w-full bg-white/20 rounded-full h-2">
                                    <div id="problems-bar" class="bg-purple-400 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-300">Compreens√£o</span>
                                    <span id="comprehension-score" class="font-semibold">--%</span>
                                </div>
                                <div class="w-full bg-white/20 rounded-full h-2">
                                    <div id="comprehension-bar" class="bg-orange-400 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recomenda√ß√µes -->
                <div class="bg-white/5 rounded-xl p-6 border border-white/10 mb-8">
                    <h3 class="text-lg font-semibold mb-4 text-center">Recomenda√ß√µes Personalizadas</h3>
                    <div id="recommendations" class="text-gray-300 space-y-3">
                        <!-- Ser√° preenchido dinamicamente -->
                    </div>
                </div>

                <!-- A√ß√µes -->
                <div class="space-y-4">
                    <button 
                        onclick="shareResult()" 
                        class="w-full bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300"
                    >
                        Compartilhar Resultado
                    </button>
                    <button 
                        onclick="restartQuiz()" 
                        class="w-full bg-white/20 hover:bg-white/30 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300"
                    >
                        Fazer Novamente
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Pagamento -->
    <div id="payment-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 max-w-md w-full border border-white/20">
            <div class="text-center">
                <h2 class="text-2xl font-bold mb-4">Libere Seu Resultado Completo</h2>
                <p class="text-gray-300 mb-6">Apenas <span class="text-green-400 font-bold">R$ 5,29</span> para descobrir seu QI detalhado!</p>
                
                <div id="qr-container" class="bg-white rounded-xl p-4 mb-6">
                    <div id="qr-code" class="w-32 h-32 mx-auto bg-gray-200 rounded-lg flex items-center justify-center">
                        <div class="loading-spinner w-8 h-8 rounded-full border-4"></div>
                    </div>
                </div>
                
                <p class="text-sm text-gray-300 mb-4">Escaneie com seu banco ou app de pagamento PIX</p>
                
                <!-- C√≥digo PIX para copiar -->
                <div id="pix-code-container" class="hidden mb-6">
                    <div class="bg-gray-800 rounded-xl p-4 border border-gray-600">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-300 font-semibold">C√≥digo PIX:</span>
                            <button 
                                id="copy-pix-btn" 
                                onclick="copyPixCode()" 
                                class="bg-primary hover:bg-primary-dark text-white text-xs px-3 py-1 rounded-lg transition-all duration-300 flex items-center space-x-1"
                            >
                                <span>üìã</span>
                                <span>Copiar</span>
                            </button>
                        </div>
                        <div id="pix-code-text" class="bg-gray-900 rounded-lg p-3 text-xs font-mono text-gray-300 break-all border border-gray-700 max-h-20 overflow-y-auto">
                            <!-- C√≥digo PIX ser√° inserido aqui -->
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-2 mb-6">
                    <button 
                        id="show-qr-btn" 
                        onclick="showPaymentMethod('qr')" 
                        class="flex-1 bg-primary/20 text-primary border border-primary text-sm py-2 px-4 rounded-lg transition-all duration-300"
                    >
                        QR Code
                    </button>
                    <button 
                        id="show-code-btn" 
                        onclick="showPaymentMethod('code')" 
                        class="flex-1 bg-gray-700 text-gray-300 border border-gray-600 text-sm py-2 px-4 rounded-lg transition-all duration-300"
                    >
                        C√≥digo PIX
                    </button>
                </div>
                
                <div id="payment-status" class="mb-6">
                    <div class="flex items-center justify-center space-x-2">
                        <div class="loading-spinner w-4 h-4 rounded-full"></div>
                        <span class="text-yellow-400">Gerando c√≥digo PIX...</span>
                    </div>
                </div>

                <button 
                    onclick="closePaymentModal()" 
                    class="w-full bg-white/20 hover:bg-white/30 text-white font-semibold py-2 px-6 rounded-xl transition-all duration-300"
                >
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Compartilhamento -->
    <div id="share-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 max-w-md w-full border border-white/20">
            <div class="text-center">
                <h2 class="text-2xl font-bold mb-6">Compartilhar Resultado</h2>
                <p class="text-gray-300 mb-8">Escolha como deseja compartilhar seu resultado:</p>
                
                <div class="space-y-4">
                    <button 
                        onclick="downloadAsPDF()" 
                        class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 flex items-center justify-center space-x-2"
                    >
                        <span class="text-xl">üìÑ</span>
                        <span>Baixar como PDF</span>
                    </button>
                    
                    <button 
                        onclick="downloadAsImage()" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 flex items-center justify-center space-x-2"
                    >
                        <span class="text-xl">üñºÔ∏è</span>
                        <span>Baixar como Imagem</span>
                    </button>
                    
                    <button 
                        onclick="shareText()" 
                        class="w-full bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 flex items-center justify-center space-x-2"
                    >
                        <span class="text-xl">üì§</span>
                        <span>Compartilhar Texto</span>
                    </button>
                </div>
                
                <button 
                    onclick="closeShareModal()" 
                    class="w-full bg-white/20 hover:bg-white/30 text-white font-semibold py-2 px-6 rounded-xl transition-all duration-300 mt-6"
                >
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Perguntas do teste de QI
        const QUESTIONS = [
            {
                question: "Qual n√∫mero vem a seguir na sequ√™ncia: 2, 4, 8, 16, ?",
                options: ["24", "32", "30", "20", "18"],
                correct: 1
            },
            {
                question: "Se CASA = 8 e MESA = 10, quanto vale JANELA?",
                options: ["12", "14", "16", "18", "20"],
                correct: 2
            },
            {
                question: "Qual √© o pr√≥ximo na sequ√™ncia: A, C, F, J, ?",
                options: ["M", "N", "O", "P", "Q"],
                correct: 3
            },
            {
                question: "Um trem sai da cidade A √†s 8h a 60 km/h. Outro sai da cidade B √†s 9h a 80 km/h. A dist√¢ncia entre as cidades √© 200 km. A que horas se encontram?",
                options: ["10h", "10h30", "11h", "11h30", "12h"],
                correct: 1
            },
            {
                question: "Qual palavra n√£o pertence ao grupo: Violino, Piano, Guitarra, Trompete, Bateria?",
                options: ["Violino", "Piano", "Guitarra", "Trompete", "Bateria"],
                correct: 4
            },
            {
                question: "Se todos os X s√£o Y, e alguns Y s√£o Z, ent√£o:",
                options: ["Todos os X s√£o Z", "Alguns X s√£o Z", "Nenhum X √© Z", "N√£o √© poss√≠vel determinar", "Todos os Z s√£o X"],
                correct: 3
            },
            {
                question: "Qual n√∫mero completa a sequ√™ncia: 1, 1, 2, 3, 5, 8, ?",
                options: ["11", "12", "13", "14", "15"],
                correct: 2
            },
            {
                question: "Ana √© mais velha que Bruno. Carlos √© mais novo que Bruno. Quem √© o mais velho?",
                options: ["Ana", "Bruno", "Carlos", "Ana e Bruno", "Imposs√≠vel determinar"],
                correct: 0
            },
            {
                question: "Qual √© o resultado de 15% de 200?",
                options: ["25", "30", "35", "40", "45"],
                correct: 1
            },
            {
                question: "Quantos tri√¢ngulos h√° em um pent√°gono estrelado?",
                options: ["5", "10", "15", "20", "25"],
                correct: 1
            },
            {
                question: "Se voc√™ reorganizar as letras 'ROUPA', qual dessas palavras pode formar?",
                options: ["PROVA", "PAROU", "NOSSA", "TEMPO", "CARRO"],
                correct: 1
            },
            {
                question: "Qual √© o oposto de 'expandir'?",
                options: ["Crescer", "Contrair", "Melhorar", "Acelerar", "Fortalecer"],
                correct: 1
            },
            {
                question: "Em uma sala h√° 4 cantos. Em cada canto h√° um gato. Cada gato v√™ 3 gatos. Quantos gatos h√° na sala?",
                options: ["3", "4", "12", "16", "Imposs√≠vel determinar"],
                correct: 1
            },
            {
                question: "Qual n√∫mero vem a seguir: 3, 7, 15, 31, ?",
                options: ["47", "55", "63", "71", "79"],
                correct: 2
            },
            {
                question: "Se AZUL = 52 e VERDE = 74, quanto vale AMARELO?",
                options: ["82", "86", "90", "94", "98"],
                correct: 2
            },
            {
                question: "Qual dessas figuras geom√©tricas tem mais lados?",
                options: ["Hex√°gono", "Oct√≥gono", "Pent√°gono", "Hept√°gono", "Ene√°gono"],
                correct: 4
            },
            {
                question: "Qual √© a raiz quadrada de 144?",
                options: ["10", "11", "12", "13", "14"],
                correct: 2
            },
            {
                question: "Se hoje √© ter√ßa-feira, que dia ser√° daqui a 100 dias?",
                options: ["Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta"],
                correct: 1
            },
            {
                question: "Quantas letras h√° entre F e Q no alfabeto?",
                options: ["9", "10", "11", "12", "13"],
                correct: 1
            },
            {
                question: "Se um livro custa R$ 20 com 25% de desconto, qual era o pre√ßo original?",
                options: ["R$ 25", "R$ 26,67", "R$ 28", "R$ 30", "R$ 35"],
                correct: 1
            },
            {
                question: "Qual palavra est√° relacionada com M√âDICO assim como TRIBUNAL est√° para:",
                options: ["Advogado", "Juiz", "Crime", "Lei", "Justi√ßa"],
                correct: 0
            },
            {
                question: "Quantos n√∫meros de 3 d√≠gitos existem?",
                options: ["900", "999", "1000", "899", "998"],
                correct: 0
            },
            {
                question: "Se A = 1, B = 2, C = 3... quanto vale a palavra PAZ?",
                options: ["42", "43", "44", "45", "46"],
                correct: 3
            },
            {
                question: "Qual √© o pr√≥ximo na sequ√™ncia: 2, 6, 12, 20, ?",
                options: ["28", "30", "32", "34", "36"],
                correct: 1
            },
            {
                question: "Um rel√≥gio demora 5 segundos para dar 6 badaladas. Quanto tempo demora para dar 12 badaladas?",
                options: ["10 segundos", "11 segundos", "12 segundos", "15 segundos", "20 segundos"],
                correct: 1
            },
            {
                question: "Qual n√∫mero n√£o pertence √† sequ√™ncia: 2, 3, 6, 7, 8, 14, 15, 30?",
                options: ["2", "8", "7", "30", "6"],
                correct: 1
            },
            {
                question: "Se voc√™ tem 3 ma√ß√£s e tira 2, quantas voc√™ tem?",
                options: ["1", "2", "3", "5", "0"],
                correct: 1
            },
            {
                question: "Quantos meses t√™m 28 dias?",
                options: ["1", "2", "11", "12", "Depende do ano"],
                correct: 3
            },
            {
                question: "Se CASA est√° para ASAC, ent√£o AMOR est√° para:",
                options: ["ROMA", "AMOR", "RAMO", "ARMO", "ORAM"],
                correct: 0
            },
            {
                question: "Qual √© o resultado da express√£o: 2 + 2 √ó 2?",
                options: ["6", "8", "4", "10", "12"],
                correct: 0
            }
        ];

        let currentQuestion = 0;
        let userAnswers = [];
        let testUuid = null;
        let paymentCheckInterval = null;
        let currentPixCode = null; // Vari√°vel para armazenar o c√≥digo PIX

        function startQuiz() {
            // Inicializar array de respostas com 30 posi√ß√µes undefined
            userAnswers = new Array(30).fill(undefined);
            currentQuestion = 0;
            
            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestion >= QUESTIONS.length) return;

            const question = QUESTIONS[currentQuestion];
            
            // Atualizar contador e progresso
            document.getElementById('question-counter').textContent = `Pergunta ${currentQuestion + 1} de ${QUESTIONS.length}`;
            const progress = ((currentQuestion) / QUESTIONS.length) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
            document.getElementById('progress-text').textContent = `${Math.round(progress)}%`;

            // Mostrar pergunta
            document.getElementById('question-text').textContent = question.question;

            // Criar op√ß√µes
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';

            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option bg-white/10 hover:bg-primary/20 border border-white/20 hover:border-primary/50 rounded-xl p-4 cursor-pointer transition-all duration-300 transform hover:scale-105';
                optionDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-6 h-6 rounded-full border-2 border-white/40 flex items-center justify-center text-sm font-semibold">
                            ${String.fromCharCode(65 + index)}
                        </div>
                        <span class="text-base">${option}</span>
                    </div>
                `;
                optionDiv.onclick = () => selectOption(index, optionDiv);
                optionsContainer.appendChild(optionDiv);
            });

            // Marcar resposta previamente selecionada (se houver)
            if (userAnswers[currentQuestion] !== undefined) {
                const previousSelection = userAnswers[currentQuestion];
                const optionElements = document.querySelectorAll('.option');
                if (optionElements[previousSelection]) {
                    selectOption(previousSelection, optionElements[previousSelection]);
                }
            }

            // Resetar bot√µes
            document.getElementById('next-btn').disabled = userAnswers[currentQuestion] === undefined;
            document.getElementById('next-btn').classList.remove('hidden');
            document.getElementById('finish-btn').classList.add('hidden');

            if (currentQuestion === QUESTIONS.length - 1) {
                document.getElementById('next-btn').classList.add('hidden');
                document.getElementById('finish-btn').classList.remove('hidden');
                document.getElementById('finish-btn').disabled = userAnswers[currentQuestion] === undefined;
            }
        }

        function selectOption(index, element) {
            // Remove sele√ß√£o anterior
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('!bg-primary/30', '!border-primary', 'selected');
            });
            
            // Adiciona sele√ß√£o atual
            element.classList.add('!bg-primary/30', '!border-primary', 'selected');
            
            // Salva resposta
            userAnswers[currentQuestion] = index;
            
            // Habilita bot√£o
            document.getElementById('next-btn').disabled = false;
            document.getElementById('finish-btn').disabled = false;
        }

        function nextQuestion() {
            if (userAnswers[currentQuestion] !== undefined) {
                currentQuestion++;
                showQuestion();
            }
        }

        function finishQuizWithValidation() {
            // Verificar se todas as perguntas foram respondidas
            const missingAnswers = [];
            for (let i = 0; i < 30; i++) {
                if (userAnswers[i] === undefined) {
                    missingAnswers.push(i + 1);
                }
            }

            if (missingAnswers.length > 0) {
                showCustomAlert(`Voc√™ ainda n√£o respondeu √†s perguntas: ${missingAnswers.join(', ')}`);
                return;
            }

            // Se todas as respostas est√£o preenchidas, prosseguir
            showPaymentModal();
        }

        async function showPaymentModal() {
            try {
                // Debug: verificar dados antes de enviar
                console.log('üîç Verificando dados antes do envio:');
                console.log('UserAnswers length:', userAnswers.length);
                console.log('UserAnswers:', userAnswers);
                
                // Verificar se temos exatamente 30 respostas
                if (userAnswers.length !== 30) {
                    throw new Error(`N√∫mero incorreto de respostas: ${userAnswers.length}/30`);
                }

                // Verificar se h√° respostas undefined
                const undefinedIndexes = [];
                userAnswers.forEach((answer, index) => {
                    if (answer === undefined || answer === null) {
                        undefinedIndexes.push(index + 1);
                    }
                });

                if (undefinedIndexes.length > 0) {
                    throw new Error(`Respostas n√£o selecionadas nas perguntas: ${undefinedIndexes.join(', ')}`);
                }

                const requestData = {
                    answers: userAnswers,
                    email: 'cliente@qi-test.com.br'
                };

                console.log('üì§ Enviando dados para o servidor:', requestData);

                // Primeiro, submeter o teste para obter o UUID
                const response = await fetch('/submit_test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('üì• Response status:', response.status);
                console.log('üì• Response headers:', Object.fromEntries(response.headers.entries()));

                const responseText = await response.text();
                console.log('üì• Response text:', responseText);

                if (!response.ok) {
                    let errorMessage = 'Erro ao processar teste';
                    try {
                        const errorData = JSON.parse(responseText);
                        errorMessage = errorData.error || errorMessage;
                        console.error('‚ùå Erro detalhado do servidor:', errorData);
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${responseText}`;
                        console.error('‚ùå Erro ao parsear resposta de erro:', e);
                    }
                    throw new Error(errorMessage);
                }

                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    console.error('‚ùå Erro ao parsear resposta JSON:', e);
                    throw new Error('Resposta inv√°lida do servidor');
                }

                console.log('‚úÖ Resultado do teste:', result);
                
                if (!result.test_uuid) {
                    throw new Error('UUID do teste n√£o retornado pelo servidor');
                }

                testUuid = result.test_uuid;

                // Mostrar modal de pagamento
                document.getElementById('payment-modal').classList.remove('hidden');

                // Criar pagamento
                await createPayment();

            } catch (error) {
                console.error('‚ùå Erro detalhado ao processar teste:', error);
                showCustomAlert(`Erro: ${error.message}`);
            }
        }

        async function createPayment() {
            try {
                updatePaymentStatus('Gerando c√≥digo PIX...', 'yellow');

                console.log('üí≥ Criando pagamento para teste UUID:', testUuid);

                const requestData = {
                    test_uuid: testUuid
                };

                console.log('üí≥ Dados da requisi√ß√£o:', requestData);

                const response = await fetch('/create_payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('üí≥ Payment response status:', response.status);
                console.log('üí≥ Payment response headers:', Object.fromEntries(response.headers.entries()));

                const responseText = await response.text();
                console.log('üí≥ Payment response text:', responseText);

                if (!response.ok) {
                    let errorMessage = 'Erro ao criar pagamento';
                    let errorDetails = '';
                    
                    try {
                        const errorData = JSON.parse(responseText);
                        errorMessage = errorData.error || errorMessage;
                        errorDetails = errorData.details ? JSON.stringify(errorData.details) : '';
                        
                        console.error('‚ùå Erro detalhado do servidor:', errorData);
                        
                        // Se for erro do Mercado Pago, mostrar detalhes
                        if (errorData.details) {
                            console.error('‚ùå Detalhes do Mercado Pago:', errorData.details);
                        }
                        
                    } catch (parseError) {
                        console.error('‚ùå Erro ao parsear resposta de erro:', parseError);
                        errorMessage = `HTTP ${response.status}: ${responseText}`;
                    }
                    
                    // Mostrar erro espec√≠fico no modal
                    if (response.status === 500) {
                        updatePaymentStatus('Erro interno do servidor. Verifique configura√ß√µes.', 'red');
                    } else if (response.status === 400) {
                        updatePaymentStatus('Dados inv√°lidos enviados.', 'red');
                    } else {
                        updatePaymentStatus(`Erro ${response.status}: ${errorMessage}`, 'red');
                    }
                    
                    throw new Error(`${errorMessage}${errorDetails ? ' - ' + errorDetails : ''}`);
                }

                let payment;
                try {
                    payment = JSON.parse(responseText);
                    console.log('‚úÖ Pagamento criado com sucesso:', payment);
                } catch (parseError) {
                    console.error('‚ùå Erro ao parsear resposta de sucesso:', parseError);
                    throw new Error('Resposta inv√°lida do servidor');
                }

                // Armazenar c√≥digo PIX para copiar
                currentPixCode = payment.qr_code_text;

                // Exibir QR Code
                if (payment.qr_code_base64) {
                    const qrCodeElement = document.getElementById('qr-code');
                    qrCodeElement.innerHTML = `<img src="data:image/png;base64,${payment.qr_code_base64}" alt="QR Code PIX" class="w-32 h-32 rounded-lg">`;
                    
                    console.log('‚úÖ QR Code exibido com sucesso');
                } else {
                    console.warn('‚ö†Ô∏è QR Code base64 n√£o retornado');
                    console.log('üìä Dados do pagamento recebidos:', payment);
                    
                    // Tentar usar QR Code texto se dispon√≠vel
                    if (payment.qr_code_text) {
                        updatePaymentStatus('QR Code gerado. Use o c√≥digo PIX para pagar.', 'yellow');
                    } else {
                        updatePaymentStatus('Pagamento criado, mas QR Code n√£o dispon√≠vel.', 'yellow');
                    }
                }

                // Preencher c√≥digo PIX para c√≥pia
                if (currentPixCode) {
                    document.getElementById('pix-code-text').textContent = currentPixCode;
                }

                updatePaymentStatus('Aguardando pagamento...', 'yellow');

                // Iniciar verifica√ß√£o de pagamento
                startPaymentCheck();

            } catch (error) {
                console.error('‚ùå Erro completo ao criar pagamento:', error);
                
                // Se n√£o atualizou o status ainda, atualizar agora
                const currentStatus = document.getElementById('payment-status').textContent;
                if (currentStatus.includes('Gerando c√≥digo PIX')) {
                    updatePaymentStatus(`Erro: ${error.message}`, 'red');
                }
            }
        }

        function showPaymentMethod(method) {
            const qrContainer = document.getElementById('qr-container');
            const codeContainer = document.getElementById('pix-code-container');
            const qrBtn = document.getElementById('show-qr-btn');
            const codeBtn = document.getElementById('show-code-btn');

            if (method === 'qr') {
                // Mostrar QR Code
                qrContainer.classList.remove('hidden');
                codeContainer.classList.add('hidden');
                
                // Atualizar bot√µes
                qrBtn.className = 'flex-1 bg-primary/20 text-primary border border-primary text-sm py-2 px-4 rounded-lg transition-all duration-300';
                codeBtn.className = 'flex-1 bg-gray-700 text-gray-300 border border-gray-600 text-sm py-2 px-4 rounded-lg transition-all duration-300';
            } else {
                // Mostrar c√≥digo PIX
                qrContainer.classList.add('hidden');
                codeContainer.classList.remove('hidden');
                
                // Atualizar bot√µes
                qrBtn.className = 'flex-1 bg-gray-700 text-gray-300 border border-gray-600 text-sm py-2 px-4 rounded-lg transition-all duration-300';
                codeBtn.className = 'flex-1 bg-primary/20 text-primary border border-primary text-sm py-2 px-4 rounded-lg transition-all duration-300';
            }
        }

        function copyPixCode() {
            if (!currentPixCode) {
                showCustomAlert('C√≥digo PIX n√£o dispon√≠vel');
                return;
            }

            navigator.clipboard.writeText(currentPixCode).then(() => {
                const button = document.getElementById('copy-pix-btn');
                const originalText = button.innerHTML;
                
                button.innerHTML = '<span>‚úÖ</span><span>Copiado!</span>';
                button.classList.add('bg-green-600');
                button.classList.remove('bg-primary', 'hover:bg-primary-dark');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-600');
                    button.classList.add('bg-primary', 'hover:bg-primary-dark');
                }, 2000);
                
            }).catch(() => {
                showCustomAlert('Erro ao copiar c√≥digo PIX');
            });
        }

        function startPaymentCheck() {
            if (paymentCheckInterval) {
                clearInterval(paymentCheckInterval);
            }

            console.log('‚è∞ Iniciando verifica√ß√£o de pagamento para UUID:', testUuid);

            paymentCheckInterval = setInterval(async () => {
                try {
                    console.log('üîç Verificando status do pagamento...');
                    
                    const response = await fetch(`/check_payment/${testUuid}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const status = await response.json();
                    console.log('üí∞ Status do pagamento:', status);

                    if (status.payment_status === 'approved') {
                        console.log('‚úÖ Pagamento aprovado!');
                        clearInterval(paymentCheckInterval);
                        updatePaymentStatus('Pagamento confirmado!', 'green');
                        
                        setTimeout(() => {
                            closePaymentModal();
                            showResult(status);
                        }, 1500);
                    } else {
                        console.log('‚è≥ Pagamento ainda pendente:', status.payment_status);
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao verificar pagamento:', error);
                }
            }, 3000); // Verificar a cada 3 segundos

            // Parar verifica√ß√£o ap√≥s 30 minutos
            setTimeout(() => {
                if (paymentCheckInterval) {
                    clearInterval(paymentCheckInterval);
                    updatePaymentStatus('Tempo limite excedido. Tente novamente.', 'red');
                }
            }, 30 * 60 * 1000);
        }

        function updatePaymentStatus(message, color) {
            const statusElement = document.getElementById('payment-status');
            const colors = {
                yellow: 'text-yellow-400',
                green: 'text-green-400',
                red: 'text-red-400'
            };

            if (color === 'green') {
                statusElement.innerHTML = `
                    <div class="flex items-center justify-center space-x-2">
                        <span class="${colors[color]}">‚úÖ ${message}</span>
                    </div>
                `;
            } else if (color === 'red') {
                statusElement.innerHTML = `
                    <div class="flex items-center justify-center space-x-2">
                        <span class="${colors[color]}">‚ùå ${message}</span>
                    </div>
                `;
            } else {
                statusElement.innerHTML = `
                    <div class="flex items-center justify-center space-x-2">
                        <div class="loading-spinner w-4 h-4 rounded-full"></div>
                        <span class="${colors[color]}">${message}</span>
                    </div>
                `;
            }
        }

        function closePaymentModal() {
            if (paymentCheckInterval) {
                clearInterval(paymentCheckInterval);
            }
            document.getElementById('payment-modal').classList.add('hidden');
        }

        function showResult(data) {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            
            // Animar score
            animateScore(data.score);
            
            // Mostrar n√≠vel e descri√ß√£o
            let level, description;
            if (data.score >= 140) {
                level = "G√™nio";
                description = "Voc√™ possui uma intelig√™ncia excepcional! Est√° entre os 0,2% mais inteligentes da popula√ß√£o.";
            } else if (data.score >= 130) {
                level = "Superdotado";
                description = "Intelig√™ncia muito superior! Voc√™ est√° entre os 2% mais inteligentes.";
            } else if (data.score >= 115) {
                level = "Acima da M√©dia";
                description = "Sua intelig√™ncia est√° acima da m√©dia populacional. Excelente!";
            } else if (data.score >= 85) {
                level = "M√©dia";
                description = "Voc√™ possui intelig√™ncia na faixa m√©dia, assim como a maioria das pessoas.";
            } else {
                level = "Abaixo da M√©dia";
                description = "H√° espa√ßo para desenvolvimento. Continue estudando e praticando!";
            }

            document.getElementById('level-text').textContent = level;
            document.getElementById('level-description').textContent = description;
            
            // Preencher estat√≠sticas detalhadas
            document.getElementById('correct-answers').textContent = `${data.correct_answers}/30`;
            document.getElementById('percentage-score').textContent = `${Math.round(data.percentage)}%`;
            document.getElementById('avg-time').textContent = `${Math.round(15 + Math.random() * 20)}s`;
            
            // Calcular posi√ß√£o populacional
            let populationPercentile;
            if (data.score >= 140) populationPercentile = 99.8;
            else if (data.score >= 130) populationPercentile = 98;
            else if (data.score >= 115) populationPercentile = 84;
            else if (data.score >= 100) populationPercentile = 50;
            else if (data.score >= 85) populationPercentile = 16;
            else populationPercentile = 5;
            
            document.getElementById('population-rank').textContent = `Top ${(100 - populationPercentile).toFixed(1)}%`;
            document.getElementById('lower-qi').textContent = `${populationPercentile.toFixed(1)}% da popula√ß√£o`;
            document.getElementById('age-equivalent').textContent = `${Math.round(18 + (data.score - 100) * 0.2)} anos`;
            
            // Classifica√ß√£o cient√≠fica
            let scientificClass;
            if (data.score >= 140) scientificClass = "Muito Superior";
            else if (data.score >= 130) scientificClass = "Superior";
            else if (data.score >= 120) scientificClass = "Acima da M√©dia Superior";
            else if (data.score >= 110) scientificClass = "Acima da M√©dia";
            else if (data.score >= 90) scientificClass = "M√©dia";
            else if (data.score >= 80) scientificClass = "Abaixo da M√©dia";
            else scientificClass = "Lim√≠trofe";
            
            document.getElementById('scientific-classification').textContent = scientificClass;
            
            // Calcular scores por habilidade baseado nas respostas reais
            const categoryScores = calculateCategoryScores(data.user_answers);
            
            Object.keys(categoryScores).forEach((category, index) => {
                const categoryScore = categoryScores[category];
                
                document.getElementById(`${category}-score`).textContent = `${Math.round(categoryScore)}%`;
                
                // Animar barras ap√≥s um delay
                setTimeout(() => {
                    document.getElementById(`${category}-bar`).style.width = `${categoryScore}%`;
                }, 1000 + (index * 200));
            });
            
            // Gerar recomenda√ß√µes baseadas no desempenho
            generateRecommendations(data.score, level, data.percentage);
        }

        function animateScore(finalScore) {
            const scoreElement = document.getElementById('score-text');
            const circleElement = document.getElementById('score-circle');
            
            let currentScore = 0;
            const increment = finalScore / 60; // 60 frames de anima√ß√£o
            
            const animation = setInterval(() => {
                currentScore += increment;
                if (currentScore >= finalScore) {
                    currentScore = finalScore;
                    clearInterval(animation);
                }
                
                const displayScore = Math.round(currentScore);
                scoreElement.textContent = displayScore;
                
                // Atualizar c√≠rculo (m√°ximo 200 para QI)
                const percentage = Math.min((displayScore / 200) * 360, 360);
                circleElement.style.setProperty('--percentage', `${percentage}deg`);
            }, 50);
        }

        function generateRecommendations(iqScore, level, percentage) {
            const recommendationsContainer = document.getElementById('recommendations');
            let recommendations = [];

            if (iqScore >= 140) {
                recommendations = [
                    "‚Ä¢ Considere participar de organiza√ß√µes para superdotados como a Mensa",
                    "‚Ä¢ Explore carreiras em pesquisa cient√≠fica, matem√°tica ou inova√ß√£o tecnol√≥gica",
                    "‚Ä¢ Desafie-se com problemas complexos e projetos multidisciplinares",
                    "‚Ä¢ Compartilhe seu conhecimento atrav√©s de mentoria ou ensino"
                ];
            } else if (iqScore >= 130) {
                recommendations = [
                    "‚Ä¢ Continue desenvolvendo suas habilidades atrav√©s de cursos avan√ßados",
                    "‚Ä¢ Considere carreiras em √°reas t√©cnicas, cient√≠ficas ou de lideran√ßa",
                    "‚Ä¢ Pratique resolu√ß√£o de problemas complexos regularmente",
                    "‚Ä¢ Explore √°reas de interesse com profundidade"
                ];
            } else if (iqScore >= 115) {
                recommendations = [
                    "‚Ä¢ Mantenha-se atualizado com leituras diversificadas",
                    "‚Ä¢ Pratique jogos de l√≥gica e quebra-cabe√ßas",
                    "‚Ä¢ Considere aprender novas habilidades ou idiomas",
                    "‚Ä¢ Busque desafios que estimulem seu crescimento intelectual"
                ];
            } else if (iqScore >= 85) {
                recommendations = [
                    "‚Ä¢ Desenvolva o h√°bito da leitura regular",
                    "‚Ä¢ Pratique exerc√≠cios de matem√°tica e l√≥gica",
                    "‚Ä¢ Mantenha-se curioso e questione o mundo ao seu redor",
                    "‚Ä¢ Busque educa√ß√£o continuada em √°reas de interesse"
                ];
            } else {
                recommendations = [
                    "‚Ä¢ Foque em desenvolver habilidades b√°sicas de matem√°tica e linguagem",
                    "‚Ä¢ Pratique exerc√≠cios de concentra√ß√£o e mem√≥ria",
                    "‚Ä¢ Busque apoio educacional especializado se necess√°rio",
                    "‚Ä¢ Mantenha uma rotina de estudos consistente"
                ];
            }

            recommendationsContainer.innerHTML = recommendations.map(rec => 
                `<div class="flex items-start space-x-2">
                    <span class="text-primary mt-1">‚Ä¢</span>
                    <span>${rec.substring(2)}</span>
                </div>`
            ).join('');
        }

        function shareResult() {
            document.getElementById('share-modal').classList.remove('hidden');
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.add('hidden');
        }

        function downloadAsPDF() {
            try {
                // Mostrar loading
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<span class="loading-spinner w-4 h-4 rounded-full inline-block"></span><span>Gerando PDF...</span>';
                button.disabled = true;

                // Usar setTimeout para permitir que o loading apare√ßa
                setTimeout(async () => {
                    try {
                        // Aguardar as bibliotecas carregarem
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        // Verificar se as bibliotecas est√£o dispon√≠veis
                        if (typeof html2canvas === 'undefined' || typeof window.jspdf === 'undefined') {
                            throw new Error('Bibliotecas n√£o carregadas');
                        }

                        // Capturar a √°rea de resultado
                        const resultArea = document.getElementById('result-screen');
                        const canvas = await html2canvas(resultArea, {
                            backgroundColor: '#1e293b',
                            scale: 1.5,
                            allowTaint: true,
                            useCORS: false
                        });

                        // Criar PDF
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        
                        // Calcular dimens√µes
                        const imgWidth = 200;
                        const pageHeight = 295;
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        let heightLeft = imgHeight;
                        
                        // Adicionar t√≠tulo
                        pdf.setFontSize(20);
                        pdf.setTextColor(93, 92, 222);
                        pdf.text('Resultado do Teste de QI', 105, 15, { align: 'center' });
                        
                        // Adicionar imagem
                        const imgData = canvas.toDataURL('image/png');
                        let position = 25;
                        
                        pdf.addImage(imgData, 'PNG', 5, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                        
                        // Se necess√°rio, adicionar p√°ginas
                        while (heightLeft >= 0) {
                            position = heightLeft - imgHeight;
                            pdf.addPage();
                            pdf.addImage(imgData, 'PNG', 5, position, imgWidth, imgHeight);
                            heightLeft -= pageHeight;
                        }
                        
                        // Adicionar data na √∫ltima p√°gina
                        pdf.setFontSize(8);
                        pdf.setTextColor(100, 100, 100);
                        pdf.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 105, 285, { align: 'center' });
                        
                        // Download
                        const score = document.getElementById('score-text').textContent;
                        pdf.save(`Resultado_QI_${score}.pdf`);
                        
                        // Restaurar bot√£o
                        button.innerHTML = originalText;
                        button.disabled = false;
                        closeShareModal();
                        
                    } catch (error) {
                        console.error('Erro ao gerar PDF:', error);
                        
                        // Fallback: mostrar aviso
                        button.innerHTML = '<span>Erro - Tente novamente</span>';
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.disabled = false;
                        }, 3000);
                    }
                }, 100);
                
            } catch (error) {
                console.error('Erro ao iniciar gera√ß√£o de PDF:', error);
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        function downloadAsImage() {
            try {
                // Mostrar loading
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<span class="loading-spinner w-4 h-4 rounded-full inline-block"></span><span>Gerando Imagem...</span>';
                button.disabled = true;

                // Usar setTimeout para permitir que o loading apare√ßa
                setTimeout(async () => {
                    try {
                        // Aguardar as bibliotecas carregarem
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        // Verificar se a biblioteca est√° dispon√≠vel
                        if (typeof html2canvas === 'undefined') {
                            throw new Error('html2canvas n√£o carregado');
                        }

                        // Capturar a √°rea de resultado
                        const resultArea = document.getElementById('result-screen');
                        const canvas = await html2canvas(resultArea, {
                            backgroundColor: '#1e293b',
                            scale: 2,
                            allowTaint: true,
                            useCORS: false
                        });

                        // Converter para blob e criar URL
                        canvas.toBlob((blob) => {
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.download = `Resultado_QI_${document.getElementById('score-text').textContent}.png`;
                            link.href = url;
                            
                            // Download
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            
                            // Limpar URL
                            URL.revokeObjectURL(url);
                            
                            // Restaurar bot√£o
                            button.innerHTML = originalText;
                            button.disabled = false;
                            closeShareModal();
                        }, 'image/png');
                        
                    } catch (error) {
                        console.error('Erro ao gerar imagem:', error);
                        
                        // Fallback: mostrar aviso
                        button.innerHTML = '<span>Erro - Tente novamente</span>';
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.disabled = false;
                        }, 3000);
                    }
                }, 100);
                
            } catch (error) {
                console.error('Erro ao iniciar gera√ß√£o de imagem:', error);
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        function shareText() {
            const score = document.getElementById('score-text').textContent;
            const level = document.getElementById('level-text').textContent;
            const text = `Acabei de descobrir meu QI! Pontua√ß√£o: ${score} - ${level}\n\nFa√ßa voc√™ tamb√©m o teste de QI!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Meu Resultado de QI',
                    text: text,
                    url: window.location.href
                });
            } else {
                // Fallback para navegadores sem suporte
                navigator.clipboard.writeText(text + '\n' + window.location.href).then(() => {
                    // Mostrar feedback visual
                    const button = event.target;
                    const originalText = button.innerHTML;
                    button.innerHTML = '<span>‚úÖ</span><span>Copiado!</span>';
                    
                    setTimeout(() => {
                        button.innerHTML = originalText;
                    }, 2000);
                });
            }
            closeShareModal();
        }

        function calculateCategoryScores(answers) {
            // Mapeamento das perguntas por categoria
            const categoryMapping = {
                logic: [0, 5, 6, 7, 13, 24, 26, 27, 28], // Racioc√≠nio l√≥gico, sequ√™ncias l√≥gicas
                math: [3, 8, 16, 18, 19, 21, 22, 23, 29], // Matem√°tica, c√°lculos
                vocabulary: [1, 4, 10, 11, 20, 28], // Vocabul√°rio, linguagem
                sequences: [0, 2, 6, 13, 14, 23, 24], // Sequ√™ncias, padr√µes
                problems: [3, 7, 12, 19, 25, 26, 27], // Resolu√ß√£o de problemas
                comprehension: [4, 5, 11, 20, 21, 28, 29] // Compreens√£o, interpreta√ß√£o
            };

            const scores = {};
            
            Object.keys(categoryMapping).forEach(category => {
                const questions = categoryMapping[category];
                let correct = 0;
                
                questions.forEach(questionIndex => {
                    if (questionIndex < answers.length && 
                        answers[questionIndex] === QUESTIONS[questionIndex].correct) {
                        correct++;
                    }
                });
                
                // Calcular percentual com base nas quest√µes da categoria
                scores[category] = (correct / questions.length) * 100;
            });
            
            return scores;
        }

        function restartQuiz() {
            currentQuestion = 0;
            userAnswers = [];
            testUuid = null;
            currentPixCode = null;
            
            if (paymentCheckInterval) {
                clearInterval(paymentCheckInterval);
            }
            
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('home-screen').classList.remove('hidden');
        }

        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4 border border-gray-600">
                    <p class="text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-4 py-2 bg-primary text-white hover:bg-primary-dark rounded" onclick="this.closest('.fixed').remove()">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Adicionar anima√ß√£o de entrada
        window.addEventListener('load', () => {
            document.body.style.opacity = '0';
            document.body.style.transition = 'opacity 0.5s ease-in-out';
            setTimeout(() => {
                document.body.style.opacity = '1';
            }, 100);
        });
    </script>
</body>
</html>
